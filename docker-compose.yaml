version: '3.8' # Docker Compose ファイルのバージョンを指定

# 各サービス（コンテナ）を定義
services:

  # Prometheus サービス
  prometheus:
    image: prom/prometheus:latest 
    container_name: prometheus 
    restart: unless-stopped
    ports:
      - '9090:9090' # ホストの9090ポートをコンテナの9090ポートにマッピング (Prometheus UI)
    volumes:
      # ホストの prometheus.yml をコンテナの設定ファイルとしてマウント
      - './prometheus.yml:/etc/prometheus/prometheus.yml'
      - prometheus_data:/prometheus
    networks:
      - monitoring_net

  # Grafana サービス
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    ports:
      - '3011:3000' # ホストの3011ポートをコンテナの3000ポートにマッピング
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - monitoring_net

  # Node Exporter サービス (ホストOSのメトリクスを収集)
  nodeexporter:
    image: prom/node-exporter:latest
    container_name: nodeexporter
    restart: unless-stopped
    ports:
      - '9100:9100' # ホストの9100ポートをコンテナの9100ポートにマッピング
    volumes:
      # ホストのルートファイルシステムを読み取り専用でマウント (Node Exporterが必要とする権限)
      - '/:/host:ro,rslave'
    command:
      - '--path.rootfs=/host'
    networks:
      - monitoring_net
    # Node Exporterはホストの情報を収集するため、ホストのPID名前空間を使用
    pid: host

volumes:
  prometheus_data: {}
  grafana_data: {}

networks:
  monitoring_net:
    driver: bridge